# File: Makefile
SHELL := /bin/bash
GCP_PROJECT := $(shell gcloud config get-value project)
GCP_REGION := us-central1
TIMESTAMP := $(shell date +%Y%m%d-%H%M%S)

# Deployment Control
deploy: validate check-gcloud-auth
	@echo "üöÄ Starting deployment to $(GCP_PROJECT)..."
	@chmod +x scripts/deploy.sh
	@./scripts/deploy.sh $(GCP_PROJECT) $(GCP_REGION) $(TIMESTAMP)
	@echo "‚úÖ Deployment completed successfully"

# CI/CD Trigger
trigger-workflow: check-gh-auth
	@echo "‚è≥ Triggering GitHub Actions workflow..."
	@gh workflow run deploy-model.yml \
		--ref $(shell git branch --show-current) \
		-f timestamp=$(TIMESTAMP)
	@echo "‚úÖ Workflow triggered. Monitor with: make status"

# Validation
validate:
	@echo "üîç Validating configuration..."
	@test -f .github/workflows/deploy-model.yml || (echo "‚ùå Error: Missing deploy-model.yml"; exit 1)
	@test -f scripts/deploy.sh || (echo "‚ùå Error: Missing deploy.sh"; exit 1)
	@test -d .git || (echo "‚ùå Error: Not a git repository"; exit 1)

# Authentication Checks
check-gcloud-auth:
	@echo "üîê Checking GCP authentication..."
	@test -n "$(GCP_PROJECT)" || (echo "‚ùå Error: Run 'gcloud auth login' first"; exit 1)

check-gh-auth:
	@echo "üîê Checking GitHub authentication..."
	@gh auth status >/dev/null 2>&1 || (echo "‚ùå Error: Run 'gh auth login' first"; exit 1)

# Monitoring
status:
	@echo "üìä Current deployments in $(GCP_REGION):"
	@gcloud ai endpoints list \
		--region=$(GCP_REGION) \
		--format="table(name, displayName, createTime)" \
		|| echo "‚ÑπÔ∏è  No endpoints found"

# Maintenance
clean:
	@echo "üßπ Cleaning temporary files..."
	@rm -fv *.log deploy/*.tmp

# Help
help:
	@echo "Available targets:"
	@echo "  deploy          - Deploy to Vertex AI"
	@echo "  trigger-workflow - Trigger GitHub Actions"
	@echo "  status          - List deployed models"
	@echo "  clean           - Remove temporary files"
	@echo "  help            - Show this help"

.PHONY: deploy trigger-workflow validate check-gcloud-auth check-gh-auth status clean help